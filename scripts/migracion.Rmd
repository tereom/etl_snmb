---
title: "Migracion de primera versión"
output: html_document
---


```{r, message=FALSE}
library(RSQLite)
library(plyr)
library(dplyr)
library(tidyr)
library(stringr)
```


La siguiente función lee la base de datos (dir), extrae una tabla (tabla) y 
regresa un _data frame_ con la tabla.

```{r}
leerDbTab <- function(dir, tabla){
  base_input <- src_sqlite(dir)
  tabla <- tbl(base_input, tabla)
  tabla_df <- collect(tabla)
}
```


### conglomerates -> Conglomerado_muestra y Sitio_muestra

1. Leemos las tablas de conglomerado y creamos un id utilizando la parte 
numérica del nombre de la base de datos y la columna id de la misma.

```{r}
# Leemos las rutas de las bases de datos de entrada
bases_rutas <- list.files(path = "../datos/bases_entrada", full.names = TRUE)
names(bases_rutas) <- extract_numeric(basename(bases_rutas))

conglomerado_tabs <- ldply(bases_rutas, leerDbTab, "conglomerates")

conglomerado <- conglomerado_tabs %>%
  filter(nchar(name) <= 5) %>%  # quitamos conglomerados con nombres mal
  mutate(
    id = as.numeric(paste(.id, id, sep = "")) # creamos nueva columna id
    ) %>%
  select(-.id) # eliminamos la columna auxiliar .id
```

2. Separamos en las dos tablas Conglomerado\_muestra y Sitio\_muestra

**Falta buscar niveles conglomerate_type y property de cliente Thilo**

```{r}
Conglomerado_muestra <- conglomerado %>% 
  mutate(
    nombre = name, 
    fecha_visita = visit_date, 
    compania = NA_character_,
    tipo = revalue(conglomerate_type, c("07) Biodiversidad" = "7 Biodiversidad")),
    estado = state,
    tenencia = revalue(property, c("01) Ejidal" = "1 Ejidal", 
      "03) Propriedad Particular" = "3 Propiedad particular")), 
    uso_suelo_tipo = NA_character_, 
    monitoreo_tipo = "SAC-MOD", 
    vegetacion_tipo = NA_character_, 
    perturbado = NA,
    comentario = comment) %>%
  select(id, nombre, fecha_visita, compania, tipo, estado, municipio, tenencia, 
         uso_suelo_tipo, monitoreo_tipo, vegetacion_tipo, perturbado, comentario)

separarSitios <- function(base_df, variable){
  base_var <- base_df  %>%
    select(id, contains(variable)) %>%
    gather(sitio, value, -id) %>%
    mutate(sitio = str_extract(sitio, "[[:alnum:]]+"))
  base_var
}

# variables que extraemos para la tabla Sitio_muestra
variables <- c("lat", "lon", "altitude", "ellipsoid", "gps_error")
names(variables) <- variables

sitio <- ldply(variables, separarSitios, base_df = conglomerado) %>%
  spread(.id, value)

Sitio_muestra <- sitio %>%
  mutate(
    conglomerado_muestra_id = id, 
    id = 1:length(id),
    sitio_numero = revalue(sitio, c("central" = "Centro", "transect2" = "Sitio 2",
      "transect3" = "Sitio 3", "transect4" = "Sitio 4")), 
    existe = TRUE,
    lat = as.numeric(lat),
    lon = as.numeric(lon),
    lat_grado = floor(lat), 
    lat_min = floor(60 * (lat - lat_grado)),
    lat_seg = (3600 * (lat - lat_grado - lat_min / 60)),
    lon_grado = floor(lon), 
    lon_min = floor(60 * (lon - lon_grado)),
    lon_seg = (3600 * (lon - lon_grado - lon_min / 60)),
    altitud = altitude,
    hay_evidencia = NA
    ) %>% 
  select(-lat, -lon, -altitude, -sitio)
```

#### invaders, file_invasores -> Transecto_especie_invasora, Especie_invasora, Archivo_Especie_invasora

Filtramos para únicamente tener registros asociados a los conglomerados en la 
tabla Conglomerado_muestra.

```{r}
invasora_tabs <- ldply(bases_rutas, leerDbTab, "invaders")
archivos_invasora_tabs <- ldply(bases_rutas, leerDbTab, "files_invasores")

# creamos nuevos ids pegando id base de datos con ids de tabla
invasora <- invasora_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    conglomerate_id = as.numeric(paste(.id, conglomerate_id, sep = ""))
  ) %>%
  filter(conglomerate_id %in% Conglomerado_muestra$id) %>%
  select(-.id) 

archivos_invasora <- archivos_invasora_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    invaders_id = as.numeric(paste(.id, invaders_id, sep = ""))
  ) %>%
  filter(invaders_id %in% invasora$id) %>%
  select(-.id) 
```

Tablas a exportar
**en archivo quitamos ruta?**
**como trabajar las horas?**

```{r}
Archivo_especie_invasora <- archivos_invasora %>%
  select(id, especie_invasora_id = invaders_id, 
    archivo_nombre_original = old_filename, 
    archivo = filename)

# Asignamos como id del transecto el id de la primera especie invasora
transecto_especies_invasoras <- invasora %>%
  separate(transect, c("nombre", "transecto_numero"), sep = "/") %>%
  group_by(conglomerate_id, transecto_numero) %>%
  mutate(
    transecto_especies_invasoras_id = first(id)
  ) %>%
  ungroup()

Transecto_especies_invasoras_muestra <- transecto_especies_invasoras %>%
  group_by(conglomerate_id, transecto_numero) %>%
  summarise_each(funs(first)) %>%
  ungroup() %>%
  mutate(
    transecto_numero = revalue(transecto_numero, 
      c("T2" = "Transecto 2", "T3" = "Transecto 3", "T4" = "Transecto 4")),
    tecnico = technician,
    fecha = NA,
    hora_inicio = start_time, 
    hora_termino = stop_time, 
    comentario = comment
  ) %>%
  select(id = transecto_especies_invasoras_id, 
    conglomerado_muestra_id = conglomerate_id, fecha,
    transecto_numero, tecnico, hora_inicio, hora_termino, comentario)


transecto_especies_invasoras$numero_individuos = cut(
  transecto_especies_invasoras$number_individuals, 
  breaks = c(-Inf, 0, 5, 10, 90, Inf))
levels(transecto_especies_invasoras$numero_individuos) <- list(
  "No aplica" = c("(-Inf,0]", "(90, Inf]"), 
  "1 a 5" = "(0,5]", 
  "6 a 10" = "(5,10]", 
  "más de 10" = "(10,90]")

Especie_invasora <- transecto_especies_invasoras %>%
  mutate(
    nombre_en_lista = !is.na(conabio_list_name),
    nombre_comun = ifelse(name_type == "common name", species_name, NA), 
    nombre_cientifico = ifelse(name_type != "common name", species_name, NA),
    numero_individuos = as.character(numero_individuos)
  ) %>%
  select(id, transecto_especies_invasoras_id, nombre_en_lista, nombre_comun, 
    nombre_cientifico, numero_individuos)
    
```

