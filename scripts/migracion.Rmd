---
title: "Migracion de primera versión"
output: html_document
---


```{r, message=FALSE}
library(RSQLite)
library(plyr)
library(dplyr)
library(tidyr)
library(stringr)
```


La siguiente función lee la base de datos (dir), extrae una tabla (tabla) y 
regresa un _data frame_ con la tabla.

```{r}
leerDbTab <- function(dir, tabla){
  base_input <- src_sqlite(dir)
  tabla <- tbl(base_input, tabla)
  tabla_df <- collect(tabla)
}
```


### conglomerates -> Conglomerado_muestra y Sitio_muestra

1. Leemos las tablas de conglomerado y creamos un id utilizando la parte 
numérica del nombre de la base de datos y la columna id de la misma.

```{r}
# Leemos las rutas de las bases de datos de entrada
bases_rutas <- list.files(path = "../datos/bases_entrada", full.names = TRUE)
names(bases_rutas) <- extract_numeric(basename(bases_rutas))

conglomerates <- ldply(bases_rutas, leerDbTab, "conglomerates")

conglomerado <- conglomerates %>%
  filter(nchar(name) <= 5) %>%  # quitamos conglomerados con nombres mal
  mutate(
    id = as.numeric(paste(.id, id, sep = "")) # creamos nueva columna id
  ) %>%
  select(-.id) # eliminamos la columna auxiliar .id
```

2. Separamos en las dos tablas Conglomerado\_muestra y Sitio\_muestra

**Falta buscar niveles conglomerate_type y property de cliente Thilo**

```{r}
Conglomerado_muestra <- conglomerado %>% 
  mutate(
    nombre = as.integer(name), 
    fecha_visita = visit_date, 
    compania = NA_character_,
    tipo = revalue(conglomerate_type, c("07) Biodiversidad" = "7 Biodiversidad")),
    estado = state,
    tenencia = revalue(property, c("01) Ejidal" = "1 Ejidal", 
      "03) Propriedad Particular" = "3 Propiedad particular")), 
    uso_suelo_tipo = NA_character_, 
    monitoreo_tipo = "SAC-MOD", 
    vegetacion_tipo = NA_character_, 
    perturbado = NA,
    comentario = comment) %>%
  select(id, nombre, fecha_visita, predio, compania, tipo, estado, municipio,
    tenencia, uso_suelo_tipo, monitoreo_tipo, vegetacion_tipo, perturbado,
    comentario)

separarSitios <- function(base_df, variable){
  base_var <- base_df  %>%
    select(id, contains(variable)) %>%
    gather(sitio, value, -id) %>%
    mutate(sitio = str_extract(sitio, "[[:alnum:]]+"))
  base_var
}

# variables que extraemos para la tabla Sitio_muestra
variables <- c("lat", "lon", "altitude", "ellipsoid", "gps_error")
names(variables) <- variables

sitio <- ldply(variables, separarSitios, base_df = conglomerado) %>%
  spread(.id, value)

Sitio_muestra <- sitio %>%
  mutate(
    conglomerado_muestra_id = id, 
    id = 1:length(id),
    sitio_numero = revalue(sitio, c("central" = "Centro", "transect2" = "Sitio 2",
      "transect3" = "Sitio 3", "transect4" = "Sitio 4")), 
    existe = TRUE,
    lat = as.numeric(lat),
    lon = as.numeric(lon),
    lat_grado = as.integer(lat), 
    lat_min = floor(60 * abs(lat - lat_grado)),
    lat_seg = (3600 * abs(lat - lat_grado - sign(lat) * lat_min / 60)),
    lon_grado = as.integer(lon), 
    lon_min = floor(60 * abs(lon - lon_grado)),
    lon_seg = (3600 * abs(lon - lon_grado - sign(lon) * lon_min / 60)),
    altitud = as.numeric(altitude),
    gps_error = as.numeric(gps_error),
    hay_evidencia = NA
    ) %>% 
  select(-lat, -lon, -altitude, -sitio)
```

#### invaders, file_invasores -> Transecto_especie_invasora, Especie_invasora, Archivo_Especie_invasora

Filtramos para únicamente tener registros asociados a los conglomerados en la 
tabla Conglomerado_muestra.

```{r}
invasora_tabs <- ldply(bases_rutas, leerDbTab, "invaders")
archivos_invasora_tabs <- ldply(bases_rutas, leerDbTab, "files_invasores")

# creamos nuevos ids pegando id base de datos con ids de tabla
invasora <- invasora_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    conglomerate_id = as.numeric(paste(.id, conglomerate_id, sep = ""))
  ) %>%
  filter(conglomerate_id %in% Conglomerado_muestra$id & number_individuals > 0) %>%
  select(-.id) 

archivos_invasora <- archivos_invasora_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    invaders_id = as.numeric(paste(.id, invaders_id, sep = ""))
  ) %>%
  filter(invaders_id %in% invasora$id) %>%
  select(-.id) 
```

Tablas a exportar
**en archivo quitamos ruta?**
**como trabajar las horas?**

```{r}
Archivo_especie_invasora <- archivos_invasora %>%
  select(id, especie_invasora_id = invaders_id, 
    archivo_nombre_original = old_filename, 
    archivo = filename)

# Asignamos como id del transecto el id de la primera especie invasora
transecto_especies_invasoras <- invasora %>%
  separate(transect, c("nombre", "transecto_numero"), sep = "/") %>%
  group_by(conglomerate_id, transecto_numero) %>%
  mutate(
    transecto_especies_invasoras_id = first(id)
  ) %>%
  ungroup()

Transecto_especies_invasoras_muestra <- transecto_especies_invasoras %>%
  group_by(conglomerate_id, transecto_numero) %>%
  summarise_each(funs(first)) %>%
  ungroup() %>%
  mutate(
    transecto_numero = revalue(transecto_numero, 
      c("T2" = "Transecto 2", "T3" = "Transecto 3", "T4" = "Transecto 4")),
    tecnico = technician,
    fecha = NA,
    hora_inicio = start_time, 
    hora_termino = stop_time, 
    comentario = comment
  ) %>%
  select(id = transecto_especies_invasoras_id, 
    conglomerado_muestra_id = conglomerate_id, fecha,
    transecto_numero, tecnico, hora_inicio, hora_termino, comentario)

# esto se puede simplificar considerando que no hay especies con cero individuos
# debido a que filtramos estos registros
# transecto_especies_invasoras$numero_individuos = cut(
#   transecto_especies_invasoras$number_individuals, 
#   breaks = c(-Inf, 0, 5, 10, 90, Inf))
# levels(transecto_especies_invasoras$numero_individuos) <- list(
#   "No aplica" = c("(-Inf,0]", "(90, Inf]"), 
#   "1 a 5" = "(0,5]", 
#   "6 a 10" = "(5,10]", 
#   "más de 10" = "(10,90]")

Especie_invasora <- transecto_especies_invasoras %>%
  mutate(
    nombre_en_lista = !is.na(conabio_list_name),
    nombre_comun = ifelse(name_type == "common name", species_name, NA), 
    nombre_cientifico = ifelse(name_type != "common name", species_name, NA),
    numero_individuos = as.character(cut(number_individuals, 
      breaks = c(0, 5, 10, 90, 99), 
      labels = c("1 a 5", "6 a 10", "más de 10", "No aplica")))
  ) %>%
  select(id, transecto_especies_invasoras_id, nombre_en_lista, nombre_comun, 
    nombre_cientifico, numero_individuos)  
```

#### tracks_excrements, file_tracks_excrements -> Transecto_huellas_excretas, Huella_excreta, Archivo_huella_excreta

```{r}
huella_tabs <- ldply(bases_rutas, leerDbTab, "tracks_excrements")
archivos_huella_tabs <- ldply(bases_rutas, leerDbTab, "files_tracks_excrements")

# obtenemos la hora inicio y hora término de la tabla invaders
invasora_horas <- select(invasora_tabs, transect, start_time, stop_time) %>%
  unique()

# creamos nuevos ids pegando id base de datos con ids de tabla
huella_excreta <- huella_tabs %>%
  left_join(invasora_horas, by = "transect") %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    conglomerate_id = as.numeric(paste(.id, conglomerate_id, sep = ""))
  ) %>%
  filter((conglomerate_id %in% Conglomerado_muestra$id) & 
      (length > 0 | width > 0)) %>%
  select(-.id) 

archivos_huella_excreta <- archivos_huella_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    tracks_excrements_id = as.numeric(paste(.id, tracks_exrements_id, sep = ""))
  ) %>%
  filter(tracks_excrements_id %in% huella_excreta$id) %>%
  select(-.id) 
```

Tablas a exportar
**en archivo quitamos ruta?**
**como trabajar las horas?**
**species_name en nombre comun o en nombre cientifico?**

```{r}
Archivo_huella_excreta <- archivos_huella_excreta %>%
  select(id, huella_excreta_id = tracks_excrements_id, 
    archivo_nombre_original = old_filename, 
    archivo = filename)

# Asignamos como id del transecto el id de la primera huella/excreta
transecto_huellas_excretas <- huella_excreta %>%  
  separate(transect, c("nombre", "transecto_numero"), sep = "/") %>%
  group_by(conglomerate_id, transecto_numero) %>%
  mutate(
    transecto_huellas_excretas_id = first(id)
  ) %>%
  ungroup()

Transecto_huellas_excretas_muestra <- transecto_huellas_excretas %>%
  group_by(conglomerate_id, transecto_numero) %>%
  summarise_each(funs(first)) %>%
  ungroup() %>%
  mutate(
    transecto_numero = revalue(transecto_numero, 
      c("T2" = "Transecto 2", "T3" = "Transecto 3", "T4" = "Transecto 4")),
    tecnico = technician,
    fecha = NA,
    hora_inicio = start_time, 
    hora_termino = stop_time, 
    comentario = comment
  ) %>%
  select(id = transecto_huellas_excretas_id, 
    conglomerado_muestra_id = conglomerate_id, fecha,
    transecto_numero, tecnico, hora_inicio, hora_termino, comentario)

Huella_excreta <- transecto_huellas_excretas %>%  
  mutate(
    es_huella = observation_type == "tracks",
    largo = length,
    ancho = width,
    nombre_comun = species_name, 
    nombre_cientifico = species_name
  ) %>%
  select(id, transecto_huellas_excretas_id, es_huella, nombre_comun, 
    nombre_cientifico, largo, ancho)  
```

```{r´}
base_output <- dbConnect(RSQLite::SQLite(), "../datos/base_salida/base_output.db")

dbWriteTable(base_output, "Conglomerado_muestra", Conglomerado_muestra,
      overwrite = FALSE, append = TRUE)
dbCommit(base_output)
dbDisconnect(base_output)
dbWriteTable(base_output, "Sitio_muestra", Sitio_muestra,
      overwrite = FALSE, append = TRUE)
```


### Cámara

```{r}
camara_tabs <- ldply(bases_rutas, leerDbTab, "trap_camera")
archivos_camara_tabs <- ldply(bases_rutas, leerDbTab, "files_trap_camera")
archivos_camara_ref_tabs <- ldply(bases_rutas, leerDbTab, "files_camera_ref")
equipo_tabs <- ldply(bases_rutas, leerDbTab, "equip_camera")

# creamos nuevos ids pegando id base de datos con ids de tabla y filtramos
equipo <- equipo_tabs %>% 
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    conglomerate_id = as.numeric(paste(.id, conglomerate_id, sep = ""))
  ) %>%
  filter(conglomerate_id %in% Conglomerado_muestra$id) %>%
  select(-.id)

camara <- camara_tabs %>%
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    conglomerate_id = as.numeric(paste(.id, conglomerate_id, sep = "")),
    camera_id = as.numeric(paste(.id, camera_id, sep = ""))
  ) %>%
  filter((conglomerate_id %in% Conglomerado_muestra$id) 
    # Hay muchos casos donde equip_camera tiene vacíos y trap_camera no
    # & (camera_id %in% equipo$id)) %>%
  select(-.id)

archivos_camara <- archivos_camara_tabs %>% 
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    trap_camera_id = as.numeric(paste(.id, trap_camera_id, sep = ""))
  ) %>%
  filter(trap_camera_id %in% camara$id) %>%
  select(-.id)

archivos_camara_ref <- archivos_camara_ref_tabs %>% 
  mutate(
    id = as.numeric(paste(.id, id, sep = "")),
    equipment_id = as.numeric(paste(.id, equipment_id, sep = ""))
  ) %>%
  filter(equipment_id %in% equipo$id) %>%
  select(-.id)
```

Camara = trap\_camara + equip\_camara

1. Hacemos el join de tal manera que preservamos todas los renglones de camara 
(trap\_camara).

2. Unimos con los ids de sitios usando la variable conglomerate_id.
```{r}
sitios_cgls <- select(Sitio_muestra, sitio_muestra_id = id, 
  conglomerate_id = conglomerado_muestra_id, sitio_numero) %>%
  mutate(
    sitio_numero = revalue(sitio_numero, c("Centro" = 1, "Sitio 2" = 2,
      "Sitio 3" = 3, "Sitio 4" = 4))
  )
    
Camara_sitio <- left_join(camara, equipo, by = c("conglomerate_id")) %>%     
  mutate(
    sitio_numero = substr(location, start = nchar(location), 
      stop = nchar(location))
  ) %>%
  left_join(sitios_cgls, by = c("conglomerate_id", "sitio_numero"))

Camara <- Camara_sitio %>%
  mutate(
    fecha_inicio = start_time,  ### regex (variable de trap_camera)
    hora_inicio = start_time,  ### regex
    fecha_termino = stop_time, ### regex
    hora_termino = stop_time, ## regex
    lat = as.numeric(loc_camera_lat),
    lon = as.numeric(loc_camera_lon),
    lat_grado = as.integer(lat), 
    lat_min = floor(60 * abs(lat - lat_grado)),
    lat_seg = (3600 * abs(lat - lat_grado - sign(lat) * lat_min / 60)),
    lon_grado = as.integer(lon), 
    lon_min = floor(60 * abs(lon - lon_grado)),
    lon_seg = (3600 * abs(lon - lon_grado - sign(lon) * lon_min / 60)),
    azimut = NA, 
    condiciones_abientales = NA, 
    resolucion = resolution,  ### revisar y empatar niveles
    sensibilidad = revalue(sensitivity, c("" = "Normal", "Alta" = "High",
      "" = "Low")),
    comentario = paste("Comentario trap_camera:", comment.x, 
      "Comentario equip_camera", comment.y)
    )
  select(id = id.x, #nos quedamos con id de la tabla trap_camara
    sitio_muestra_id, 
    nombre = camera, 
    fecha_inicio, hora_inicio,
    fecha_termino, hora_termino,
    lat_grado, lat_min, lat_seg,
    lon_grado, lon_min, lon_seg,
    elipsoide = loc_camera_ellipsoid, 
    gps_error = loc_camera_gps_error,
    altitud = loc_camera_altitude,
    distancia_centro = distance, 
    azimut, condiciones_ambientales


    )
  
  
```

